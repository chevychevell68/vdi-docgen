{# templates/presales/form.html #}
{% extends "base.html" %}
{% block title %}Horizon Presales Discovery{% endblock %}

{% block content %}
<h1 class="mb-3">Horizon Presales Discovery</h1>
<p class="text-muted">Architect-led conversation. Do not send to customers.</p>

{# ---- Flash messages ---- #}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="mb-3">
      {% for category, msg in messages %}
        <div class="alert alert-{{ 'danger' if category=='error' else category }} alert-dismissible fade show" role="alert">
          {{ msg }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

{# Simple helper to read values from the `form` dict #}
{% macro val(name, default='') -%}
  {{ (form[name] if form and name in form else default) }}
{%- endmacro %}

{# Universal yes/no checkbox (truthy if any of: True, 'on', 'yes', 'true', '1', 'checked') #}
{% macro yes_checkbox(name, label_text) -%}
  {% set raw = form.get(name) if form else None %}
  {% set truthy = raw in [True, 'on', 'yes', 'true', '1', 'checked'] %}
  <div class="form-check mb-2">
    <input class="form-check-input" type="checkbox" id="{{name}}" name="{{name}}" value="on" {% if truthy %}checked{% endif %}>
    <label class="form-check-label" for="{{name}}">{{ label_text }}</label>
  </div>
{%- endmacro %}

<form method="post" id="presales-form" novalidate>
  <!-- 0) Customer Info -->
  <fieldset class="border p-3 mb-4">
    <legend>Customer Info</legend>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Company name</label>
        <input class="form-control" name="company_name" value="{{ val('company_name') }}" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Customer name (primary contact)</label>
        <input class="form-control" name="customer_name" value="{{ val('customer_name') }}" required>
      </div>

      <div class="col-md-6">
        <label class="form-label">Salesforce Opportunity name</label>
        <input class="form-control" name="sf_opportunity_name" value="{{ val('sf_opportunity_name') }}">
      </div>
      <div class="col-md-6">
        <label class="form-label">IR number</label>
        <input class="form-control" name="ir_number" value="{{ val('ir_number') }}" placeholder="e.g., IR-123456">
      </div>

      <div class="col-md-12">
        <label class="form-label">Salesforce Opportunity URL</label>
        <input type="url" class="form-control" name="sf_opportunity_url"
               placeholder="https://your-instance.lightning.force.com/lightning/r/Opportunity/..."
               value="{{ val('sf_opportunity_url') }}">
      </div>

      <div class="col-md-4">
        {{ yes_checkbox('existing_vdi', 'Existing VDI in environment?') }}
      </div>

      {% set existing_vdi_truthy = (form.get('existing_vdi') in [True,'on','yes','true','1','checked']) if form else False %}
      <div class="col-12" id="existing_vdi_pain_group" style="display:{{ 'block' if existing_vdi_truthy else 'none' }};">
        <label class="form-label">If yes, top pain points</label>
        <textarea class="form-control" name="existing_vdi_pain" rows="2">{{ val('existing_vdi_pain') }}</textarea>
      </div>

      <div class="col-12">
        <label class="form-label">Voice of the Customer (VoC)</label>
        <textarea class="form-control" name="voc" rows="4" placeholder="Business drivers, pain points, success criteria, deadlines, risk tolerance…">{{ val('voc') }}</textarea>
      </div>
    </div>
  </fieldset>

  <!-- 1) Users & Scope -->
  <fieldset class="border p-3 mb-4">
    <legend>Users & Scope</legend>
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Total users</label>
        <input type="number" class="form-control" name="total_users" min="0" value="{{ val('total_users') }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Concurrent users (peak)</label>
        <input type="number" class="form-control" id="concurrent_users" name="concurrent_users" min="0" required value="{{ val('concurrent_users') }}">
      </div>
      <div class="col-md-4">
        <label class="form-label"># of datacenters/regions</label>
        <input type="number" class="form-control" name="num_datacenters" min="1" value="{{ val('num_datacenters') }}">
      </div>
      <div class="col-12">
        <label class="form-label">Datacenters/regions (where)</label>
        <input class="form-control" name="datacenters_detail" value="{{ val('datacenters_detail') }}" placeholder="City/region list">
      </div>

      <div class="col-md-4">
        <label class="form-label">Deployment type</label>
        {% set dep = val('deployment_type') %}
        <select class="form-select" name="deployment_type">
          <option value="" {{ 'selected' if dep=='' else '' }}>Select…</option>
          <option {{ 'selected' if dep=='On-prem' else '' }}>On-prem</option>
          <option {{ 'selected' if dep=='Cloud' else '' }}>Cloud</option>
          <option {{ 'selected' if dep=='Hybrid' else '' }}>Hybrid</option>
        </select>
      </div>

      <!-- Region checklist with % -->
      <div class="col-12">
        <label class="form-label d-block">User locations (regional mix)</label>
        <div class="row g-2 align-items-center">
          {% set regions_list = [
            ('US', 'Continental US'),
            ('US_HI', 'US – HI'),
            ('US_AK', 'US – AK'),
            ('CAN', 'Canada'),
            ('LATAM', 'LATAM'),
            ('EMEA', 'EMEA'),
            ('APAC', 'APAC'),
            ('INDIA', 'India'),
            ('ANZ', 'ANZ'),
            ('OTHER', 'Other')
          ] %}
          {% set regions_map = form.get('regions', {}) if form else {} %}
          {% for key, label in regions_list %}
            {% set checked = key in regions_map %}
            {% set pct_val = regions_map.get(key) if checked else '' %}
            <div class="col-md-3">
              <div class="form-check">
                <input class="form-check-input region-check" type="checkbox"
                       id="reg_{{key}}" name="region_ck_{{key}}" {% if checked %}checked{% endif %}>
                <label class="form-check-label" for="reg_{{key}}">{{ label }}</label>
              </div>
              <div class="input-group input-group-sm mt-1">
                <input type="number" min="0" max="100" step="1"
                       class="form-control region-pct"
                       id="reg_{{key}}_pct" name="region_pct_{{key}}"
                       value="{{ pct_val }}" placeholder="%"
                       {% if not checked %}disabled{% endif %}>
                <span class="input-group-text">%</span>
              </div>
            </div>
          {% endfor %}
        </div>
        <div class="mt-2">
          <span class="badge text-bg-secondary">Total: <span id="region_total">{{ form.get('regions_total', 0) if form else 0 }}</span>%</span>
          <small class="text-muted ms-2">Must equal 100%.</small>
          <div id="region_error" class="text-danger small mt-1" style="display:none;">
            Regional mix must total 100%.
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <label class="form-label"># of distinct personas/use cases</label>
        <input type="number" class="form-control" id="num_personas" name="num_personas" min="1" value="{{ val('num_personas') }}">
      </div>

      <!-- Dynamic use case inputs -->
      <div class="col-12" id="use_case_fields">
        <label class="form-label">Use case details</label>
        <div class="mb-2">
          <input class="form-control" name="main_use_cases" id="main_use_cases" placeholder="Main use case" value="{{ val('main_use_cases') }}">
        </div>
        <div id="secondary_use_cases_container"></div>
      </div>
    </div>
  </fieldset>

  <!-- 2) Graphics / GPU -->
  <fieldset class="border p-3 mb-4">
    <legend>Graphics / GPU</legend>

    {{ yes_checkbox('gpu_required', 'GPU Required?') }}

    {% set gpu_truthy = (form.get('gpu_required') in [True,'on','yes','true','1','checked']) if form else False %}
    <div id="gpu_details" style="display:{{ 'block' if gpu_truthy else 'none' }};">
      <div class="row g-3 mt-1">
        <div class="col-md-4">
          <label class="form-label">GPU users (estimate)</label>
          <input type="number" class="form-control" name="gpu_users" min="0" value="{{ val('gpu_users') }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Target GPU profile / VRAM per user (GB)</label>
          <input type="number" class="form-control" name="gpu_vram_per_user" min="0" step="0.5" value="{{ val('gpu_vram_per_user') }}">
        </div>
        <div class="col-12">
          <label class="form-label">GPU use case</label>
          <input class="form-control" name="gpu_use_case" value="{{ val('gpu_use_case') }}" placeholder="3D/CAD, imaging, video editing, ML inferencing…">
        </div>
      </div>
    </div>
  </fieldset>

  <!-- 3) Image & Applications -->
  <fieldset class="border p-3 mb-4">
    <legend>Image & Applications</legend>
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label"># of base images</label>
        <input type="number" class="form-control" id="num_images" name="num_images" min="1" value="{{ val('num_images', '1') }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Gold image provided by customer?</label>
        {% set gis = val('gold_image_source', 'WWT builds') %}
        <div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="gold_image_source" id="gis_wwt" value="WWT builds" {% if gis=='WWT builds' %}checked{% endif %}>
            <label class="form-check-label" for="gis_wwt">WWT builds</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="gold_image_source" id="gis_cust" value="Customer provides" {% if gis=='Customer provides' %}checked{% endif %}>
            <label class="form-check-label" for="gis_cust">Customer provides</label>
          </div>
        </div>
      </div>

      <!-- Profile mgmt checkboxes -->
      {% set profile = form.get('profile_mgmt', []) if form else [] %}
      <div class="col-md-4">
        <label class="form-label d-block">Profile management</label>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="pm_dem" name="profile_mgmt" value="DEM" {% if 'DEM' in profile %}checked{% endif %}>
          <label class="form-check-label" for="pm_dem">DEM</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="pm_fslogix" name="profile_mgmt" value="FSLogix" {% if 'FSLogix' in profile %}checked{% endif %}>
          <label class="form-check-label" for="pm_fslogix">FSLogix</label>
        </div>
      </div>

      <!-- Virtual apps checkboxes -->
      {% set vapps = form.get('virtual_apps', []) if form else [] %}
      <div class="col-md-4">
        <label class="form-label d-block">Virtual apps?</label>
        <div class="form-check">
          <input class="form-check-input va-check" type="checkbox" id="va_appvol" name="virtual_apps" value="App Volumes" {% if 'App Volumes' in vapps %}checked{% endif %}>
          <label class="form-check-label" for="va_appvol">App Volumes</label>
        </div>
        <div class="form-check">
          <input class="form-check-input va-check" type="checkbox" id="va_rdsh" name="virtual_apps" value="RDSH" {% if 'RDSH' in vapps %}checked{% endif %}>
          <label class="form-check-label" for="va_rdsh">RDSH</label>
        </div>
      </div>

      <div class="col-12" id="required_apps_group" style="display:{% if 'App Volumes' in vapps %}block{% else %}none{% endif %};">
        <label class="form-label">Required applications</label>
        <textarea class="form-control" name="required_apps" rows="3" placeholder="List app names/versions/licensing nuances…">{{ val('required_apps') }}</textarea>
      </div>

      <div class="col-md-4">
        {{ yes_checkbox('wwt_app_packaging', 'WWT responsible for app packaging?') }}
      </div>
    </div>
  </fieldset>

  <!-- 4) Access & Identity -->
  <fieldset class="border p-3 mb-4">
    <legend>Access & Identity</legend>
    <div class="row g-3">
      <div class="col-md-4">
        {{ yes_checkbox('remote_access', 'Remote access required?') }}
      </div>

      <div class="col-md-4">
        {{ yes_checkbox('mfa_required', 'MFA required?') }}
      </div>

      {% set mfa_truthy = (form.get('mfa_required') in [True,'on','yes','true','1','checked']) if form else False %}
      <div class="col-md-4" id="mfa_solution_group" style="display:{{ 'block' if mfa_truthy else 'none' }};">
        <label class="form-label">Existing MFA solution</label>
        <input class="form-control" name="mfa_solution" value="{{ val('mfa_solution') }}" placeholder="Duo, Okta, Azure, etc.">
      </div>

      <div class="col-md-4">
        {{ yes_checkbox('smartcard', 'Smart card authentication?') }}
      </div>

      <div class="col-md-8">
        <label class="form-label">Workspace ONE Access or 3rd-party IdP</label>
        <input class="form-control" name="idp_provider" value="{{ val('idp_provider') }}" placeholder="WS1 Access / Okta / Entra ID / ADFS / Ping…">
      </div>
    </div>
  </fieldset>

  <!-- 5) Endpoints -->
  <fieldset class="border p-3 mb-4">
    <legend>Endpoints</legend>
    <div class="row g-3">
      <div class="col-md-4">
        {{ yes_checkbox('endpoint_provisioning', 'Provision/configure endpoints?') }}
      </div>
      <div class="col-md-8">
        <label class="form-label">Endpoint types</label>
        <input class="form-control" name="endpoint_types" value="{{ val('endpoint_types') }}" placeholder="Thin clients, PCs/laptops, zero clients, tablets…">
      </div>
      <div class="col-md-4">
        <label class="form-label">Thin client management required?</label>
        <input class="form-control" name="thin_client_mgmt" value="{{ val('thin_client_mgmt') }}" placeholder="HPDM, Stratodesk, IGEL…">
      </div>
    </div>
  </fieldset>

  <!-- 6) Directory & Core Services -->
  <fieldset class="border p-3 mb-4">
    <legend>Directory & Core Services</legend>
    <div class="row g-3">
      {% set ad_exists = val('ad_exists') %}
      <div class="col-md-4">
        <label class="form-label d-block">Existing AD forest/domains?</label>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="ad_exists" id="ad_no" value="No" {% if ad_exists=='No' %}checked{% endif %}>
          <label class="form-check-label" for="ad_no">No</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="ad_exists" id="ad_yes" value="Yes" {% if ad_exists=='Yes' %}checked{% endif %}>
          <label class="form-check-label" for="ad_yes">Yes</label>
        </div>
      </div>
      <div class="col-md-4">
        <label class="form-label"># of domains / trusts</label>
        <input type="number" class="form-control" name="num_domains" min="1" value="{{ val('num_domains') }}">
      </div>

      <div class="col-md-6">
        <label class="form-label">Domain name for virtual desktops</label>
        <input class="form-control" name="vd_domain_name" value="{{ val('vd_domain_name') }}" placeholder="e.g., corp.example.com">
      </div>
      <div class="col-md-6">
        <label class="form-label">Separate domain for core servers?</label>
        <input class="form-control" name="core_domain_name" value="{{ val('core_domain_name') }}" placeholder="If separate, specify domain/FQDN">
      </div>
    </div>
  </fieldset>

  <!-- 7) Platform & Infra -->
  <fieldset class="border p-3 mb-4">
    <legend>Platform & Infra</legend>
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Hypervisor/platform</label>
        {% set platform = val('platform') %}
        <select class="form-select" name="platform" id="platform">
          <option value="" {{ 'selected' if platform=='' else '' }}>Select…</option>
          <option {{ 'selected' if platform=='vSphere (ESXi)' else '' }}>vSphere (ESXi)</option>
          <option {{ 'selected' if platform=='Hyper-V' else '' }}>Hyper-V</option>
          <option {{ 'selected' if platform=='Nutanix AHV' else '' }}>Nutanix AHV</option>
          <option {{ 'selected' if platform=='KVM' else '' }}>KVM</option>
          <option {{ 'selected' if platform=='Other' else '' }}>Other</option>
        </select>
      </div>

      <div class="col-md-4">
        {{ yes_checkbox('general_compute_cluster', 'General compute cluster available for core components?') }}
      </div>

      <!-- Host sizing -->
      <div class="col-md-3">
        <label class="form-label">Host CPU cores</label>
        <input type="number" class="form-control" id="host_cpu_cores" name="host_cpu_cores" min="1" required value="{{ val('host_cpu_cores') }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Host RAM (GB)</label>
        <input type="number" class="form-control" id="host_ram_gb" name="host_ram_gb" min="1" required value="{{ val('host_ram_gb') }}">
      </div>
      <div class="col-md-3">
        <label class="form-label"># of hosts (cluster)</label>
        <input type="number" class="form-control" name="hosts_count" min="1" value="{{ val('hosts_count') }}">
      </div>

      <!-- VM persona sizing -->
      <div class="col-md-3">
        <label class="form-label">VM vCPU</label>
        <input type="number" class="form-control" id="vm_vcpu" name="vm_vcpu" min="1" value="{{ val('vm_vcpu', '2') }}" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">VM RAM (GB)</label>
        <input type="number" class="form-control" id="vm_ram_gb" name="vm_ram_gb" min="1" value="{{ val('vm_ram_gb', '8') }}" required>
      </div>

      <!-- vCPU:pCPU ratio -->
      {% set vratio = (val('vcpu_to_pcpu')|string) %}
      <div class="col-md-3">
        <label class="form-label">vCPU : pCPU ratio</label>
        <select class="form-select" id="vcpu_to_pcpu" name="vcpu_to_pcpu">
          <option value="4" {{ 'selected' if (not form or vratio=='4') else '' }}>1:4</option>
          <option value="5" {{ 'selected' if vratio=='5' else '' }}>1:5</option>
          <option value="6" {{ 'selected' if vratio=='6' else '' }}>1:6</option>
        </select>
      </div>

      <!-- Storage -->
      {% set storage_type = val('storage_type') %}
      <div class="col-md-3">
        <label class="form-label">Storage type</label>
        <select class="form-select" name="storage_type" id="storage_type">
          <option value="" {{ 'selected' if storage_type=='' else '' }}>Select…</option>
          <option {{ 'selected' if storage_type=='vSAN' else '' }}>vSAN</option>
          <option {{ 'selected' if storage_type=='Pure' else '' }}>Pure</option>
          <option {{ 'selected' if storage_type=='Other' else '' }}>Other</option>
        </select>
      </div>

      <!-- vSAN calc inputs -->
      <div class="col-md-3 vsan-only" style="display:{% if storage_type=='vSAN' %}block{% else %}none{% endif %};">
        <label class="form-label">Base image size (GB)</label>
        <input type="number" class="form-control" id="base_image_gb" name="base_image_gb" value="{{ val('base_image_gb', '40') }}" min="1">
      </div>
      <div class="col-md-3 vsan-only" style="display:{% if storage_type=='vSAN' %}block{% else %}none{% endif %};">
        <label class="form-label">vSAN policy factor</label>
        {% set vsan_factor = (val('vsan_policy_factor','2.0')|string) %}
        <select class="form-select" id="vsan_policy_factor" name="vsan_policy_factor">
          <option value="2.0"  {{ 'selected' if vsan_factor=='2.0' else '' }}>FTT1 RAID1 (≈2.0x)</option>
          <option value="1.33" {{ 'selected' if vsan_factor=='1.33' else '' }}>FTT1 RAID5 (≈1.33x)</option>
          <option value="3.0"  {{ 'selected' if vsan_factor=='3.0' else '' }}>FTT2 RAID1 (≈3.0x)</option>
        </select>
      </div>

      <!-- Advanced tunables -->
      <div class="col-12 vsan-only" style="display:{% if storage_type=='vSAN' %}block{% else %}none{% endif %};">
        <details>
          <summary>Advanced vSAN & density tunables</summary>
          <div class="row g-3 mt-2">
            <div class="col-md-3">
              <label class="form-label">IC delta per user (GB)</label>
              <input type="number" class="form-control" id="delta_gb" name="delta_gb" value="{{ val('delta_gb', '6') }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Per-VM overhead (GB)</label>
              <input type="number" class="form-control" id="per_vm_overhead_gb" name="per_vm_overhead_gb" value="{{ val('per_vm_overhead_gb', '1') }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Growth/cushion factor</label>
              <input type="number" step="0.01" class="form-control" id="growth_factor" name="growth_factor" value="{{ val('growth_factor', '1.10') }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Mem headroom (%)</label>
              <input type="number" class="form-control" id="mem_headroom_pct" name="mem_headroom_pct" value="{{ val('mem_headroom_pct', '0.20') }}" step="0.01">
            </div>
            <div class="col-md-3">
              <label class="form-label">ESXi overhead (GB)</label>
              <input type="number" class="form-control" id="esxi_overhead_gb" name="esxi_overhead_gb" value="{{ val('esxi_overhead_gb', '8') }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">GPU sessions cap (per host)</label>
              <input type="number" class="form-control" id="gpu_sessions_cap" name="gpu_sessions_cap" value="{{ val('gpu_sessions_cap', '0') }}" min="0">
            </div>
          </div>
        </details>
      </div>

      <!-- Read-only results -->
      <div class="col-md-4 vsan-only" style="display:{% if storage_type=='vSAN' %}block{% else %}none{% endif %};">
        <label class="form-label">vSAN capacity for Instant Clones (GB)</label>
        <div class="form-control-plaintext fw-bold" id="vsan_total_gb">—</div>
      </div>
      <div class="col-md-4">
        <label class="form-label">Users per host (est.)</label>
        <div class="form-control-plaintext fw-bold" id="per_host_density">—</div>
      </div>

      <!-- External array fields -->
      <div class="col-md-4 non-vsan-only" style="display:{% if storage_type and storage_type!='vSAN' %}block{% else %}none{% endif %};">
        <label class="form-label">Storage vendor/model</label>
        <input class="form-control" name="storage_vendor_model" value="{{ val('storage_vendor_model') }}" placeholder="e.g., Pure X50R3">
      </div>
      <div class="col-md-4 non-vsan-only" style="display:{% if storage_type and storage_type!='vSAN' %}block{% else %}none{% endif %};">
        <label class="form-label">Protocol</label>
        <input class="form-control" name="storage_protocol" value="{{ val('storage_protocol') }}" placeholder="NFS / iSCSI / FC">
      </div>
      <div class="col-md-4 non-vsan-only" style="display:{% if storage_type and storage_type!='vSAN' %}block{% else %}none{% endif %};">
        <label class="form-label">Usable capacity (GB)</label>
        <input type="number" class="form-control" name="storage_usable_gb" min="1" value="{{ val('storage_usable_gb') }}">
      </div>

      <!-- Load balancer -->
      {% set lb = val('load_balancer') %}
      <div class="col-md-4">
        <label class="form-label">Load balancer</label>
        <select class="form-select" name="load_balancer" id="load_balancer">
          <option value="">Select…</option>
          {% for opt in ['F5 BIG-IP','NSX Advanced Load Balancer (Avi)','Citrix ADC (NetScaler)','NGINX','HAProxy','A10 Thunder','Kemp LoadMaster','AWS ALB / NLB','Azure Load Balancer / Front Door','GCP Load Balancer','Other'] %}
            <option {% if lb==opt %}selected{% endif %}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </fieldset>

  <!-- 8) Operations & Enablement -->
  <fieldset class="border p-3 mb-4">
    <legend>Operations & Enablement</legend>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Operations staffing</label>
        {% set ogs = val('ogs_staffing') %}
        <select class="form-select" name="ogs_staffing">
          <option value="" {{ 'selected' if ogs=='' else '' }}>Select…</option>
          <option {{ 'selected' if ogs=='Dedicated to VDI' else '' }}>Dedicated to VDI</option>
          <option {{ 'selected' if ogs=='Shared — other duties besides VDI' else '' }}>Shared — other duties besides VDI</option>
        </select>
      </div>

      <div class="col-md-6">
        <label class="form-label">Monitoring</label>
        {% set mon = val('monitoring_stack') %}
        {% set mon_opts = ['ControlUp (Platform)','ControlUp Edge DX','VMware Aria Operations (vROps)','Lakeside SysTrack','Nexthink','Liquidware Stratusphere UX','Goliath','eG Innovations','Login VSI / Login Enterprise','Other','None'] %}
        <select class="form-select" name="monitoring_stack" id="monitoring_stack">
          <option value="" {{ 'selected' if mon=='' else '' }}>Select…</option>
          {% for opt in mon_opts %}
            <option {{ 'selected' if mon==opt else '' }}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>

      {% set training = form.get('training_required', []) if form else ['Admin','Helpdesk','End-user'] %}
      <div class="col-md-12">
        <label class="form-label d-block">Training required</label>
        {% for label in ['Admin','Helpdesk','End-user'] %}
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="train_{{ label|lower }}" name="training_required" value="{{ label }}" {% if label in training %}checked{% endif %}>
            <label class="form-check-label" for="train_{{ label|lower }}">{{ label }}</label>
          </div>
        {% endfor %}
      </div>

      <div class="col-md-6">
        <label class="form-label">Typical onboarding time (per user)</label>
        <div class="input-group">
          <input type="number" class="form-control" name="onboarding_time_value" min="0" value="{{ val('onboarding_time_value') }}" placeholder="e.g., 2">
          {% set ot_unit = val('onboarding_time_unit') %}
          <select class="form-select" name="onboarding_time_unit" style="max-width: 10rem;">
            <option value="" {{ 'selected' if ot_unit=='' else '' }}>Select unit…</option>
            <option {{ 'selected' if ot_unit=='hours' else '' }}>hours</option>
            <option {{ 'selected' if ot_unit=='days' else '' }}>days</option>
          </select>
        </div>
        <div class="form-text">Estimate the hands-on time to fully onboard one user.</div>
      </div>

      <div class="col-md-12">
        <label class="form-label">Knowledge Transfer (KT) expectations</label>
        <textarea class="form-control" name="kt_expectations" rows="2">{{ val('kt_expectations') }}</textarea>
      </div>

      <div class="col-md-4">
        {{ yes_checkbox('runbook_required', 'Runbook required?') }}
      </div>
      <div class="col-md-4">
        {{ yes_checkbox('adoption_services', 'Adoption Services needed?') }}
      </div>
      <div class="col-md-4">
        {{ yes_checkbox('ha_dr', 'HA/DR in-scope?') }}
      </div>
    </div>
  </fieldset>

  <!-- 9) Logistics & Delivery Model -->
  <fieldset class="border p-3 mb-4">
    <legend>Logistics & Delivery Model</legend>
    <div class="row g-3">
      <div class="col-md-8">
        <label class="form-label">Delivery model</label>
        {% set dm = val('delivery_model') %}
        {% set dm_opts = ['WWT builds end-to-end','WWT over-the-shoulder workshops','Hybrid (shared tasks)'] %}
        <select class="form-select" name="delivery_model">
          <option value="" {{ 'selected' if dm=='' else '' }}>Select…</option>
          {% for opt in dm_opts %}
            <option {{ 'selected' if dm==opt else '' }}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Target start date</label>
        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ val('start_date') }}">
      </div>

      <div class="col-md-4">
        <label class="form-label">Timeline / deadlines</label>
        <input class="form-control" name="timeline" value="{{ val('timeline') }}">
      </div>

      {% set docs = form.get('docs_requested', []) if form else ['SOW','HLD','LLD','Runbook','PDG','LOE/WBS','ATP','Adoption Plan'] %}
      <div class="col-md-4">
        <label class="form-label d-block">Docs requested</label>
        {% for opt in ['SOW','HLD','LLD','Runbook','PDG','LOE/WBS','ATP','Adoption Plan'] %}
          {% set safe_id = 'doc_' + opt|lower|replace(' ', '_')|replace('/', '') %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="{{ safe_id }}" name="docs_requested" value="{{ opt }}" {% if opt in docs %}checked{% endif %}>
            <label class="form-check-label" for="{{ safe_id }}">{{ 'PDG (Project Definition Guide)' if opt=='PDG' else opt }}</label>
          </div>
        {% endfor %}
      </div>

      <div class="col-12">
        <label class="form-label">Stakeholders / 3rd parties</label>
        <textarea class="form-control" name="stakeholders" rows="2">{{ val('stakeholders') }}</textarea>
      </div>
    </div>
  </fieldset>

  <button class="btn btn-primary">Save</button>
</form>

<!-- Version badge -->
<div style="position: fixed; right: 10px; bottom: 8px; font-size: 12px; color: #6c757d;">
  Form v1.7.0
</div>

<!-- Conditional UI & Auto-calcs -->
<script>
(function () {
  // Helpers
  function el(id){ return document.getElementById(id); }
  function num(id, fallback=0){ const e=el(id); const v=parseFloat(e?.value); return isNaN(v)?fallback:v; }
  function setText(id,v){ const e=el(id); if(e){ e.textContent = v; } }
  function truthyInput(nameOrId){
    const direct = el(nameOrId);
    if (direct) return !!direct.checked;
    const r = document.querySelector(`input[name="${nameOrId}"]:checked`);
    return !!(r && String(r.value).toLowerCase() === 'yes');
  }

  // Default start date ~30 days out if blank
  (function setDefaultStartDate(){
    const input = el("start_date");
    if (!input || input.value) return;
    const d = new Date(); d.setDate(d.getDate() + 30);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    input.value = `${yyyy}-${mm}-${dd}`;
  })();

  // Toggling
  function toggleExistingVDI(){ const grp=el('existing_vdi_pain_group'); if(!grp) return; grp.style.display = truthyInput('existing_vdi') ? '' : 'none'; }
  function toggleMFA(){ const grp=el('mfa_solution_group'); if(!grp) return; grp.style.display = truthyInput('mfa_required') ? '' : 'none'; }
  function toggleGPU(){ const wrap=el('gpu_details'); if(!wrap) return; wrap.style.display = truthyInput('gpu_required') ? '' : 'none'; }
  function toggleRequiredApps(){
    const appvol = el("va_appvol");
    const grp = el("required_apps_group");
    if (grp) grp.style.display = appvol && appvol.checked ? "" : "none";
  }
  function toggleStorageGroups(){
    const t = el("storage_type")?.value || "";
    document.querySelectorAll(".vsan-only").forEach(x => x.style.display = (t === "vSAN" ? "" : "none"));
    document.querySelectorAll(".non-vsan-only").forEach(x => x.style.display = (t && t !== "vSAN" ? "" : "none"));
  }

  // Calcs
  function computeVSAN(){
    if ((el("storage_type")?.value || "") !== "vSAN"){ setText("vsan_total_gb", "—"); return; }
    const N          = num("concurrent_users");
    const images     = num("num_images", 1);
    const vmMem      = num("vm_ram_gb", 8);
    const baseImg    = num("base_image_gb", 40);
    const vsanFactor = num("vsan_policy_factor", 2.0);
    const delta      = num("delta_gb", 6);
    const overhead   = num("per_vm_overhead_gb", 1);
    const growth     = num("growth_factor", 1.10);
    const perVMWritable = delta + vmMem + overhead;
    const replicas      = images * baseImg;
    const raw           = (N * perVMWritable) + replicas;
    const total         = raw * vsanFactor * growth;
    setText("vsan_total_gb", Math.ceil(total).toLocaleString());
  }
  function computeDensity(){
    const cores   = num("host_cpu_cores");
    const hostMem = num("host_ram_gb");
    const vmvCPU  = num("vm_vcpu", 2);
    const vmMem   = num("vm_ram_gb", 8);
    const ratio     = num("vcpu_to_pcpu", 4);
    const headroom  = num("mem_headroom_pct", 0.20);
    const esxiOH    = num("esxi_overhead_gb", 8);
    const gpuCap    = num("gpu_sessions_cap", 0);
    const cpuCap  = Math.floor((cores * ratio) / vmvCPU);
    const usable  = (hostMem * (1 - headroom)) - esxiOH;
    const memCap  = Math.floor(usable / vmMem);
    let d = Math.min(cpuCap, memCap);
    if (gpuCap > 0) d = Math.min(d, gpuCap);
    setText("per_host_density", (isFinite(d) && d>=0) ? String(d) : "—");
  }

  // Regions
  function regionToggleEnable(e) {
    const key = e.target.id.replace("reg_", "");
    const pct = el(`reg_${key}_pct`);
    if (!pct) return;
    pct.disabled = !e.target.checked;
    if (!e.target.checked) pct.value = "";
    sumRegions();
  }
  function sumRegions() {
    const inputs = document.querySelectorAll(".region-pct:not([disabled])");
    let total = 0;
    inputs.forEach(i => { const v = parseFloat(i.value); if (!isNaN(v)) total += v; });
    setText("region_total", String(Math.round(total)));
    const err = el("region_error");
    if (err) err.style.display = (Math.round(total) === 100 ? "none" : "");
    return Math.round(total);
  }
  function attachRegionHandlers() {
    document.querySelectorAll(".region-check").forEach(cb => cb.addEventListener("change", regionToggleEnable));
    document.querySelectorAll(".region-pct").forEach(inp => inp.addEventListener("input", sumRegions));
    sumRegions();
  }

  // Dynamic fields
  function renderUseCaseFields() {
    const n = parseInt(el("num_personas")?.value || "0", 10);
    const container = el("secondary_use_cases_container");
    if (!container) return;
    container.innerHTML = "";
    if (n <= 1) return;
    for (let i = 2; i <= n; i++) {
      const div = document.createElement("div");
      div.className = "mb-2";
      div.innerHTML = `<input class="form-control" name="secondary_use_case_${i}" placeholder="Secondary use case ${i}">`;
      container.appendChild(div);
    }
  }

  // Submit guard
  function guardSubmitForRegions() {
    const form = el("presales-form");
    if (!form) return;
    form.addEventListener("submit", function (e) {
      const anyChecked = !!document.querySelector(".region-check:checked");
      if (anyChecked && sumRegions() !== 100) {
        e.preventDefault();
        e.stopPropagation();
        el("region_error")?.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    });
  }

  const watched = [
    "storage_type",
    "concurrent_users","num_images","vm_ram_gb","base_image_gb","vsan_policy_factor",
    "delta_gb","per_vm_overhead_gb","growth_factor",
    "host_cpu_cores","host_ram_gb","vm_vcpu","vcpu_to_pcpu","mem_headroom_pct","esxi_overhead_gb","gpu_sessions_cap"
  ];

  function recalc(){
    toggleExistingVDI();
    toggleRequiredApps();
    toggleStorageGroups();
    toggleMFA();
    toggleGPU();
    computeVSAN();
    computeDensity();
  }

  function attach(){
    watched.forEach(id => el(id)?.addEventListener("input", recalc));

    // Conditional blocks
    el('existing_vdi')?.addEventListener('change', toggleExistingVDI);
    el('mfa_required')?.addEventListener('change', toggleMFA);
    el('gpu_required')?.addEventListener('change', toggleGPU);
    document.querySelectorAll('.va-check').forEach(c => c.addEventListener("change", toggleRequiredApps));

    el("num_personas")?.addEventListener("input", renderUseCaseFields);

    attachRegionHandlers();
    guardSubmitForRegions();

    renderUseCaseFields();
    recalc();
  }

  // Safety defaults if hidden fields aren’t present in DOM (used in calc)
  if (!el("mem_headroom_pct")) {
    const hidden = document.createElement("div");
    hidden.innerHTML = `
      <input type="hidden" id="mem_headroom_pct" value="0.20">
      <input type="hidden" id="esxi_overhead_gb" value="8">
      <input type="hidden" id="gpu_sessions_cap" value="0">
    `;
    document.body.appendChild(hidden);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", attach);
  } else {
    attach();
  }
})();
</script>
{% endblock %}
