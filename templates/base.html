<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}VDI Tools{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .req-asterisk { color: #dc3545; margin-left: 2px; }
      .placeholder-helper { opacity: 0.95; }
      .yesno-check { margin-right: 6px; transform: scale(1.2); vertical-align: middle; }
    </style>
  </head>

  <body class="bg-light" style="font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('index') }}">WWT Markdown</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link {% if request.endpoint == 'presales' %}active{% endif %}" href="{{ url_for('presales') }}">Presales Discovery</a></li>
            <li class="nav-item"><a class="nav-link {% if request.endpoint == 'pdg' %}active{% endif %}" href="{{ url_for('pdg') }}">Project Definition Guide</a></li>
            <li class="nav-item"><a class="nav-link {% if request.endpoint == 'predeploy' %}active{% endif %}" href="{{ url_for('predeploy') }}">Pre-Deployment Guide</a></li>
            {% if has_endpoint('history') %}
            <li class="nav-item"><a class="nav-link {% if request.endpoint == 'history' %}active{% endif %}" href="{{ url_for('history') }}">History</a></li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <main class="container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Add asterisks to all required fields' labels -->
    <script>
      (function () {
        function markRequired(root) {
          const fields = root.querySelectorAll('input[required], select[required], textarea[required]');
          fields.forEach(function (el) {
            let label = null;
            if (el.id) label = root.querySelector('label[for="' + el.id + '"]');
            if (!label) {
              let p = el.closest('.col-md-12, .col-md-8, .col-md-6, .col-md-4, .mb-3, .form-group, fieldset, .row, div');
              while (p && !label) {
                label = p.querySelector('label.form-label') || p.querySelector('label');
                if (label) break;
                p = p.parentElement;
              }
            }
            if (label && !label.dataset.requiredDecorated) {
              const span = document.createElement('span');
              span.className = 'req-asterisk';
              span.textContent = ' *';
              label.appendChild(span);
              label.dataset.requiredDecorated = '1';
            }
          });
        }
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => markRequired(document));
        else markRequired(document);
      })();
    </script>

    <!-- Inject smart placeholders for presales form fields (non-intrusive) -->
    <script>
      (function () {
        const NUM_HINT='e.g., 250', GB_HINT='e.g., 512', URL_HINT='https://your-instance.example.com/...', DATE_HINT='e.g., 2025-10-20', PCT_HINT='e.g., 20', FACTOR_HINT='e.g., 1.10';
        function setIfEmpty(el, t){ if(!el||el.hasAttribute('placeholder'))return; el.setAttribute('placeholder',t); el.classList.add('placeholder-helper'); }
        function ensureSelectPrompt(sel){ if(!sel||sel.dataset.selectDecorated)return;const f=sel.options[0];const looks=f&&(f.disabled||/select/i.test(f.text)||f.value==='');if(!looks){const o=document.createElement('option');o.textContent='Select...';o.value='';o.disabled=true;o.selected=!sel.value;sel.insertBefore(o,sel.firstChild);}sel.dataset.selectDecorated='1';}
        function applySmart(el){
          const key=((el.name||'')+' '+(el.id||'')).toLowerCase();
          if(['radio','checkbox','button','submit'].includes(el.type))return;
          if(key.includes('url')||key.includes('salesforce')){setIfEmpty(el,URL_HINT);return;}
          if(key.includes('company')){setIfEmpty(el,'e.g., Centene Corporation');return;}
          if(key.includes('customer')){setIfEmpty(el,'e.g., Jane Smith');return;}
          if(key.includes('contact')){setIfEmpty(el,'e.g., john.doe@company.com');return;}
          if(key.includes('concurrent')||key.includes('total_users')){setIfEmpty(el,NUM_HINT);return;}
          if(key.includes('num_images')){setIfEmpty(el,'e.g., 3');return;}
          if(key.includes('host_cpu_cores')){setIfEmpty(el,'e.g., 64');return;}
          if(key.includes('host_ram_gb')){setIfEmpty(el,GB_HINT);return;}
          if(key.includes('vm_vcpu')){setIfEmpty(el,'e.g., 2');return;}
          if(key.includes('vm_ram_gb')){setIfEmpty(el,'e.g., 8');return;}
          if(key.includes('vcpu_to_pcpu')){setIfEmpty(el,'e.g., 4');return;}
          if(key.includes('base_image_gb')){setIfEmpty(el,'e.g., 40');return;}
          if(key.includes('delta_gb')){setIfEmpty(el,'e.g., 6');return;}
          if(key.includes('per_vm_overhead_gb')){setIfEmpty(el,'e.g., 1');return;}
          if(key.includes('growth_factor')){setIfEmpty(el,FACTOR_HINT);return;}
          if(key.includes('vsan_policy_factor')){setIfEmpty(el,'e.g., 2.0');return;}
          if(key.includes('gpu_sessions_cap')){setIfEmpty(el,'e.g., 16');return;}
          if(key.match(/region_pct_|_pct\b|percent/)){setIfEmpty(el,PCT_HINT);return;}
          if(key.includes('start_date')){setIfEmpty(el,DATE_HINT);return;}
          if(key.includes('timeline')){setIfEmpty(el,'e.g., Pilot by Nov 15; Prod by Dec 5');return;}
          if(key.includes('platform')){setIfEmpty(el,'e.g., vSphere 8.0.3');return;}
          if(key.includes('storage_type')){setIfEmpty(el,'e.g., vSAN');return;}
          if(key.includes('mfa_solution')){setIfEmpty(el,'e.g., Duo, Okta Verify');return;}
          if(key.includes('remote_access')){setIfEmpty(el,'e.g., UAG via Internet');return;}
          if(key.includes('endpoint_types')){setIfEmpty(el,'e.g., Windows, macOS, IGEL');return;}
          if(key.includes('main_use_cases')){setIfEmpty(el,'e.g., Task workers, call center');return;}
          if(key.includes('secondary_use_case')){setIfEmpty(el,'e.g., Power users need 16GB RAM');return;}
          if(/_gb\b/.test(key)){setIfEmpty(el,GB_HINT);return;}
          if(/\bcount|\bnum|\bcores|\bsessions|\busers/.test(key)){setIfEmpty(el,NUM_HINT);return;}
          if(el.type==='url'){setIfEmpty(el,URL_HINT);return;}
        }
        function decorate(root){root.querySelectorAll('input,textarea,select').forEach(el=>{if(el.tagName.toLowerCase()==='select')ensureSelectPrompt(el);else applySmart(el);});}
        if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',()=>decorate(document));else decorate(document);
      })();
    </script>

    <!-- Convert Yes/No radio/select groups into a single checkbox with hidden 'Yes' -->
    <script>
      (function () {
        function convertYesNo(root) {
          const processed = new Set();

          // --- Radios: find groups with exactly Yes/No
          const radios = Array.from(root.querySelectorAll('input[type="radio"][name]'));
          const byName = {};
          radios.forEach(r => { (byName[r.name] = byName[r.name] || []).push(r); });

          Object.entries(byName).forEach(([name, inputs]) => {
            if (processed.has(name)) return;
            if (inputs.length < 2) return;

            let hasYes = false, hasNo = false;
            inputs.forEach(r => {
              const val = (r.value || '').trim().toLowerCase();
              if (val === 'yes') hasYes = true;
              if (val === 'no') hasNo = true;
              const lab = r.id ? root.querySelector('label[for="' + r.id + '"]') : null;
              const txt = lab ? lab.textContent.trim().toLowerCase() : '';
              if (txt === 'yes') hasYes = true;
              if (txt === 'no') hasNo = true;
            });
            if (!(hasYes && hasNo)) return;

            // Locate question label (not the inline yes/no labels)
            const container = inputs[0].closest('.mb-3, .form-group, fieldset, .row') || inputs[0].parentElement;
            const qLabel = container.querySelector('label.form-label') || container.querySelector('label:not([for])');
            const qText  = qLabel ? qLabel.textContent.trim() : (name.replace(/[_\-]/g,' ') + '?');

            // Build checkbox + hidden
            const wrapper = document.createElement('div');
            wrapper.className = 'form-check mb-3';

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.className = 'form-check-input yesno-check';
            cb.id = name + '_cb';

            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = name;
            hidden.value = '';

            const yesSelected = inputs.some(r => r.checked && ((r.value||'').toLowerCase() === 'yes'));
            cb.checked = yesSelected;
            hidden.value = yesSelected ? 'Yes' : '';

            cb.addEventListener('change', () => { hidden.value = cb.checked ? 'Yes' : ''; });

            const newLabel = document.createElement('label');
            newLabel.className = 'form-check-label';
            newLabel.htmlFor = cb.id;
            newLabel.textContent = qText;
            // carry forward asterisk if present
            const star = qLabel && qLabel.querySelector('.req-asterisk');
            if (star) newLabel.appendChild(star.cloneNode(true));

            wrapper.append(cb, newLabel, hidden);
            container.replaceWith(wrapper);
            processed.add(name);
          });

          // --- Selects: options Yes/No
          const selects = Array.from(root.querySelectorAll('select[name], select[id]'));
          selects.forEach(sel => {
            if (sel.dataset.ynConverted) return;
            const opts = Array.from(sel.options).map(o => (o.textContent || '').trim().toLowerCase());
            if (!(opts.includes('yes') && opts.includes('no'))) return;

            const container = sel.closest('.mb-3, .form-group, fieldset, .row') || sel.parentElement;
            const qLabel = container.querySelector('label.form-label') || container.querySelector('label:not([for])');
            const qText  = qLabel ? qLabel.textContent.trim() : ((sel.name || sel.id || 'option') + '?');

            const wrapper = document.createElement('div');
            wrapper.className = 'form-check mb-3';

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.className = 'form-check-input yesno-check';
            cb.id = (sel.name || sel.id) + '_cb';

            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = sel.name || sel.id;
            hidden.value = '';

            const isYes = ((sel.value || '').trim().toLowerCase() === 'yes');
            cb.checked = isYes;
            hidden.value = isYes ? 'Yes' : '';
            cb.addEventListener('change', () => { hidden.value = cb.checked ? 'Yes' : ''; });

            const newLabel = document.createElement('label');
            newLabel.className = 'form-check-label';
            newLabel.htmlFor = cb.id;
            newLabel.textContent = qText;
            const star = qLabel && qLabel.querySelector('.req-asterisk');
            if (star) newLabel.appendChild(star.cloneNode(true));

            wrapper.append(cb, newLabel, hidden);
            container.replaceWith(wrapper);
            sel.dataset.ynConverted = '1';
          });
        }

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => convertYesNo(document));
        else convertYesNo(document);
      })();
    </script>
  </body>
</html>
