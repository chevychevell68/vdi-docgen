<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}VDI Tools{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .req-asterisk { color: #dc3545; margin-left: 2px; }
      .placeholder-helper { opacity: 0.95; }
      .yesno-check { margin-right: 6px; transform: scale(1.1); vertical-align: middle; }
      .yn-hidden { display:none !important; }
    </style>
  </head>

  <body class="bg-light" style="font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('index') }}">WWT Markdown</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link {% if request.endpoint == 'presales' %}active{% endif %}" href="{{ url_for('presales') }}">Presales Discovery</a></li>
            <li class="nav-item"><a class="nav-link {% if request.endpoint == 'pdg' %}active{% endif %}" href="{{ url_for('pdg') }}">Project Definition Guide</a></li>
            <li class="nav-item"><a class="nav-link {% if request.endpoint == 'predeploy' %}active{% endif %}" href="{{ url_for('predeploy') }}">Pre-Deployment Guide</a></li>
            {% if has_endpoint('history') %}
            <li class="nav-item"><a class="nav-link {% if request.endpoint == 'history' %}active{% endif %}" href="{{ url_for('history') }}">History</a></li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <main class="container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Required-field asterisks -->
    <script>
      (function () {
        function markRequired(root) {
          const fields = root.querySelectorAll('input[required], select[required], textarea[required]');
          fields.forEach(function (el) {
            let label = null;
            if (el.id) label = root.querySelector('label[for="' + el.id + '"]');
            if (!label) {
              let p = el.closest('.col-md-12, .col-md-8, .col-md-6, .col-md-4, .mb-3, .form-group, fieldset, .row, div');
              while (p && !label) {
                label = p.querySelector('label.form-label') || p.querySelector('label');
                if (label) break;
                p = p.parentElement;
              }
            }
            if (label && !label.dataset.requiredDecorated) {
              const span = document.createElement('span');
              span.className = 'req-asterisk';
              span.textContent = ' *';
              label.appendChild(span);
              label.dataset.requiredDecorated = '1';
            }
          });
        }
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => markRequired(document));
        else markRequired(document);
      })();
    </script>

    <!-- Smart placeholders -->
    <script>
      (function () {
        const NUM='e.g., 250', GB='e.g., 512', URL='https://your-instance.example.com/...', DATE='e.g., 2025-10-20', PCT='e.g., 20', FACTOR='e.g., 1.10';
        function setIfEmpty(el,t){ if(!el||el.hasAttribute('placeholder'))return; el.setAttribute('placeholder',t); el.classList.add('placeholder-helper'); }
        function selectPrompt(sel){ if(!sel||sel.dataset.selectDecorated)return; const f=sel.options[0]; const looks=f&&(f.disabled||/select/i.test(f.text)||f.value===''); if(!looks){const o=document.createElement('option'); o.textContent='Select...'; o.value=''; o.disabled=true; o.selected=!sel.value; sel.insertBefore(o,sel.firstChild);} sel.dataset.selectDecorated='1'; }
        function apply(el){
          const key=((el.name||'')+' '+(el.id||'')).toLowerCase();
          if(['radio','checkbox','button','submit'].includes(el.type))return;
          if(key.includes('url')||key.includes('salesforce')){setIfEmpty(el,URL);return;}
          if(key.includes('company')){setIfEmpty(el,'e.g., Centene Corporation');return;}
          if(key.includes('customer')){setIfEmpty(el,'e.g., Jane Smith');return;}
          if(key.includes('contact')){setIfEmpty(el,'e.g., john.doe@company.com');return;}
          if(key.includes('concurrent')||key.includes('total_users')){setIfEmpty(el,NUM);return;}
          if(key.includes('num_images')){setIfEmpty(el,'e.g., 3');return;}
          if(key.includes('host_cpu_cores')){setIfEmpty(el,'e.g., 64');return;}
          if(key.includes('host_ram_gb')){setIfEmpty(el,GB);return;}
          if(key.includes('vm_vcpu')){setIfEmpty(el,'e.g., 2');return;}
          if(key.includes('vm_ram_gb')){setIfEmpty(el,'e.g., 8');return;}
          if(key.includes('vcpu_to_pcpu')){setIfEmpty(el,'e.g., 4');return;}
          if(key.includes('base_image_gb')){setIfEmpty(el,'e.g., 40');return;}
          if(key.includes('delta_gb')){setIfEmpty(el,'e.g., 6');return;}
          if(key.includes('per_vm_overhead_gb')){setIfEmpty(el,'e.g., 1');return;}
          if(key.includes('growth_factor')){setIfEmpty(el,FACTOR);return;}
          if(key.includes('vsan_policy_factor')){setIfEmpty(el,'e.g., 2.0');return;}
          if(key.includes('gpu_sessions_cap')){setIfEmpty(el,'e.g., 16');return;}
          if(key.match(/region_pct_|_pct\b|percent/)){setIfEmpty(el,PCT);return;}
          if(key.includes('start_date')){setIfEmpty(el,DATE);return;}
          if(key.includes('timeline')){setIfEmpty(el,'e.g., Pilot by Nov 15; Prod by Dec 5');return;}
          if(key.includes('platform')){setIfEmpty(el,'e.g., vSphere 8.0.3');return;}
          if(key.includes('storage_type')){setIfEmpty(el,'e.g., vSAN');return;}
          if(key.includes('mfa_solution')){setIfEmpty(el,'e.g., Duo, Okta Verify');return;}
          if(key.includes('remote_access')){setIfEmpty(el,'e.g., UAG via Internet');return;}
          if(key.includes('endpoint_types')){setIfEmpty(el,'e.g., Windows, macOS, IGEL');return;}
          if(key.includes('main_use_cases')){setIfEmpty(el,'e.g., Task workers, call center');return;}
          if(key.includes('secondary_use_case')){setIfEmpty(el,'e.g., Power users need 16GB RAM');return;}
          if(/_gb\b/.test(key)){setIfEmpty(el,GB);return;}
          if(/\bcount|\bnum|\bcores|\bsessions|\busers/.test(key)){setIfEmpty(el,NUM);return;}
          if(el.type==='url'){setIfEmpty(el,URL);return;}
        }
        function run(root){ root.querySelectorAll('input,textarea,select').forEach(el=>{ if(el.tagName.toLowerCase()==='select') selectPrompt(el); else apply(el); }); }
        if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',()=>run(document)); else run(document);
      })();
    </script>

    <!-- SAFE Yes/No conversion: insert checkbox; disable+hide original radios/select -->
    <script>
      (function () {
        function nearestQuestionLabel(el) {
          // Prefer a label with .form-label in ancestors; else a previous sibling label
          let p = el.closest('.mb-3, .form-group, fieldset, .row, div');
          if (p) {
            let lab = p.querySelector('label.form-label');
            if (lab) return lab;
          }
          let prev = el.previousElementSibling;
          while (prev) {
            if (prev.tagName && prev.tagName.toLowerCase() === 'label') return prev;
            prev = prev.previousElementSibling;
          }
          return null;
        }

        function makeCheckboxUI(name, qText, requiredStar) {
          const wrap = document.createElement('div');
          wrap.className = 'form-check mb-2';

          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.className = 'form-check-input yesno-check';
          cb.id = name + '_cb';

          const hid = document.createElement('input');
          hid.type = 'hidden';
          hid.name = name;
          hid.value = '';

          cb.addEventListener('change', () => { hid.value = cb.checked ? 'Yes' : ''; });

          const lab = document.createElement('label');
          lab.className = 'form-check-label';
          lab.htmlFor = cb.id;
          lab.textContent = qText || (name.replace(/[_\-]/g,' ') + '?');
          if (requiredStar) lab.appendChild(requiredStar.cloneNode(true));

          wrap.append(cb, lab, hid);
          return { wrap, cb, hid };
        }

        function convertRadioGroups(root) {
          const radios = Array.from(root.querySelectorAll('input[type="radio"][name]'));
          const groups = {};
          radios.forEach(r => (groups[r.name] = groups[r.name] || []).push(r));

          Object.entries(groups).forEach(([name, list]) => {
            if (list.length < 2) return;

            // Determine if this is a Yes/No group
            let hasYes = false, hasNo = false;
            list.forEach(r => {
              const val = (r.value || '').trim().toLowerCase();
              const lab = r.id ? root.querySelector('label[for="' + r.id + '"]') : null;
              const txt = lab ? lab.textContent.trim().toLowerCase() : '';
              if (val === 'yes' || txt === 'yes') hasYes = true;
              if (val === 'no'  || txt === 'no')  hasNo = true;
            });
            if (!(hasYes && hasNo)) return;

            // Build UI and insert BEFORE the first radio group's container
            const first = list[0];
            const qLabel = nearestQuestionLabel(first);
            const star = qLabel && qLabel.querySelector('.req-asterisk');
            const qText = qLabel ? qLabel.textContent.trim() : '';

            const { wrap, cb, hid } = makeCheckboxUI(name, qText, star);

            // Insert just before the first radio element (or its small container)
            const insertionPoint = first.closest('.form-check, .mb-2, .mb-3, .form-group') || first;
            insertionPoint.parentElement.insertBefore(wrap, insertionPoint);

            // Initialize from current selection
            const yesSelected = list.some(r => r.checked && (((r.value||'').toLowerCase() === 'yes')));
            cb.checked = yesSelected;
            hid.value = yesSelected ? 'Yes' : '';

            // Hide + disable original radios without removing layout blocks
            const groupAncestor = insertionPoint.closest('.mb-3, .form-group, fieldset, .row') || insertionPoint;
            // Only hide the specific radio rows
            list.forEach(r => {
              r.disabled = true;
              const rc = r.closest('.form-check, .form-check-inline') || r;
              rc.classList.add('yn-hidden');
            });
          });
        }

        function convertSelectYesNo(root) {
          const selects = Array.from(root.querySelectorAll('select[name], select[id]'));
          selects.forEach(sel => {
            if (sel.dataset.ynConverted) return;
            const values = Array.from(sel.options).map(o => (o.textContent || '').trim().toLowerCase());
            if (!(values.includes('yes') && values.includes('no'))) return;

            const name = sel.name || sel.id;
            const qLabel = nearestQuestionLabel(sel);
            const star = qLabel && qLabel.querySelector('.req-asterisk');
            const qText = qLabel ? qLabel.textContent.trim() : '';

            const { wrap, cb, hid } = makeCheckboxUI(name, qText, star);

            // Insert before the select element
            sel.parentElement.insertBefore(wrap, sel);

            const isYes = ((sel.value || '').trim().toLowerCase() === 'yes');
            cb.checked = isYes;
            hid.value = isYes ? 'Yes' : '';

            // Hide + disable original select
            sel.disabled = true;
            sel.classList.add('yn-hidden');

            sel.dataset.ynConverted = '1';
          });
        }

        function run(root) {
          convertRadioGroups(root);
          convertSelectYesNo(root);
        }

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => run(document));
        else run(document);
      })();
    </script>
  </body>
</html>
