{% extends "base.html" %}
{% block title %}Submission Complete{% endblock %}
{% block content %}

{% macro yesno(v) -%}
  {%- if v is string -%}{%- if v|lower in ['yes','true','on','1','checked'] -%}Yes{%- else -%}No{%- endif -%}
  {%- else -%}{%- if v -%}Yes{%- else -%}No{%- endif -%}{%- endif -%}
{%- endmacro %}

{# Helper: build a safe download URL; prefer /download/<sid>/<filename> if available #}
{% macro dl_link(filename) -%}
  {%- if has_endpoint('download_deliverable') and ctx and ctx.sid -%}
    {{ url_for('download_deliverable', submit_id=ctx.sid, filename=filename) }}
  {%- elif has_endpoint('download_docx') -%}
    {{ url_for('download_docx', name=filename) }}
  {%- else -%}
    {{ '/download/' ~ (ctx.sid if ctx and ctx.sid else submit_id) ~ '/' ~ filename }}
  {%- endif -%}
{%- endmacro %}

{# Fixed-label button resolver. Prefer prefixed (endswith) matches FIRST, then exact. #}
{% macro doc_href(pretty_label) -%}
  {%- set suffix_map = {
    'SOW': 'SOW.docx',
    'HLD': 'HLD.docx',
    'LLD': 'LLD.docx',
    'Runbook': 'Runbook.docx',
    'LOE': 'LOE.docx',
    'WBS': 'WBS.docx',
    'ATP': 'ATP.docx',
    'Adoption Plan': 'Adoption_Plan.docx',
    'PDG Template': 'PDG.docx'
  } -%}
  {%- set target = suffix_map.get(pretty_label, pretty_label ~ '.docx') -%}

  {%- set ns = namespace(match='') -%}
  {%- if ctx and ctx.deliverables -%}
    {# 1) endswith match for prefixed names like PACAF-XYZ-SOW.docx #}
    {%- for d in ctx.deliverables -%}
      {%- if not ns.match and d.filename and (d.filename|lower).endswith('-' ~ (target|lower)) -%}
        {%- set ns.match = d.filename -%}
      {%- endif -%}
    {%- endfor -%}
    {# 2) exact match as fallback (plain SOW.docx in root) #}
    {%- if not ns.match -%}
      {%- for d in ctx.deliverables -%}
        {%- if not ns.match and d.filename == target -%}
          {%- set ns.match = d.filename -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}
  {%- endif -%}
  {%- if ns.match -%}{{ dl_link(ns.match) }}{%- else -%}{{ '' }}{%- endif -%}
{%- endmacro %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h3 mb-1">Presales Data</h1>
    <div class="text-muted small">
      <strong>Company:</strong> {{ (data.get('company_name') or '—')|upper }}
      {% if data.get('project_name') %} | <strong>Project:</strong> {{ data.get('project_name') }}{% endif %}
    </div>
  </div>
  <span class="text-muted">Submitted {{ now.strftime('%Y-%m-%d %H:%M UTC') }}</span>
</div>

<div class="mb-4">
  <a class="btn btn-primary me-2" href="{{ url_for('presales_zip', submit_id=submit_id) }}">All Docs (.zip)</a>

  {% if has_endpoint('tools_generate') %}
    <a class="btn btn-warning me-2" href="{{ url_for('tools_generate', submit_id=submit_id) }}">Regenerate Docs</a>
  {% else %}
    <a class="btn btn-warning me-2" href="{{ '/tools/generate/' ~ submit_id }}">Regenerate Docs</a>
  {% endif %}

  {% set labels = ['SOW','HLD','LLD','Runbook','LOE','WBS','ATP','Adoption Plan'] %}
  {% for label in labels %}
    {% set href = doc_href(label) %}
    {% if href %}
      <a class="btn btn-outline-secondary me-2 mb-2" href="{{ href }}">{{ label }}</a>
    {% endif %}
  {% endfor %}

  {% set pdg_href = doc_href('PDG Template') %}
  {% if pdg_href %}
    <a class="btn btn-outline-success me-2 mb-2" href="{{ pdg_href }}">PDG Template</a>
  {% endif %}
  <a class="btn btn-outline-primary mb-2" href="{{ url_for('presales_upload_pdg', submit_id=submit_id) }}">Upload PDG</a>

  {% if data.get('docs_requested_list') and docx_missing and docx_missing|length > 0 %}
    <div class="small text-muted mt-2">
      Requested but not found on server: {{ docx_missing|join(', ') }}
    </div>
  {% endif %}
</div>

{# ---------------------- RESTORED FULL SUBMITTED CONTENT ---------------------- #}

<!-- Summary card -->
<div class="card mb-4 mt-3">
  <div class="card-body">
    <h2 class="h5 mb-3">Summary</h2>
    <div class="row g-3">
      <div class="col-md-4"><div class="text-muted small">Company</div><div class="fw-medium">{{ data.get('company_name') or '—' }}</div></div>
      <div class="col-md-4"><div class="text-muted small">Total Users</div><div class="fw-medium">{{ data.get('total_users') or '—' }}</div></div>
      <div class="col-md-4"><div class="text-muted small">Concurrent Peak</div><div class="fw-medium">{{ data.get('concurrent_users') or '—' }}</div></div>
    </div>
    <div class="mt-3">
      <div class="text-muted small mb-1">Users per region (from regional mix):</div>
      <div class="table-responsive">
        <table class="table table-sm table-bordered mb-0" style="max-width:620px">
          <thead class="table-light"><tr><th>Region</th><th class="text-end">% Mix</th><th class="text-end">Users</th></tr></thead>
          <tbody>
            {% set _regions = ['US','US_HI','US_AK','CAN','LATAM','EMEA','APAC','INDIA','ANZ','OTHER'] %}
            {% set _total = (data.get('total_users') or 0) | int %}
            {% set ns = namespace(sum=0) %}
            {% for rk in _regions %}
              {% set pct = (data.get('region_pct_' ~ rk) or 0) | int %}
              {% set ck = data.get('region_ck_' ~ rk) %}
              {% if ck and pct > 0 %}
                {% set n = (_total * pct // 100) %}
                {% set ns.sum = ns.sum + n %}
                <tr><td>{{ rk }}</td><td class="text-end">{{ pct }}%</td><td class="text-end">{{ "{:,}".format(n) }}</td></tr>
              {% endif %}
            {% endfor %}
            <tr class="table-light"><th class="text-end" colspan="2">Total</th><th class="text-end">{{ "{:,}".format(ns.sum) }}</th></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<a class="btn btn-outline-secondary ms-2" href="{{ url_for('history') }}">History</a>
<a class="btn btn-link ms-1" href="{{ url_for('presales') }}">Back to Presales form</a>

<!-- 0) Customer Info -->
<fieldset class="border p-3 mb-4 rounded-2">
  <legend class="float-none w-auto px-2">Customer Info</legend>
  <div class="row g-3">
    <div class="col-md-6"><div class="form-label">Company name</div><div class="form-control-plaintext">{{ data.get('company_name') or '—' }}</div></div>
    <div class="col-md-6"><div class="form-label">Customer name (primary contact)</div><div class="form-control-plaintext">{{ data.get('customer_name') or '—' }}</div></div>
    <div class="col-md-6"><div class="form-label">Salesforce Opportunity name</div><div class="form-control-plaintext">{{ data.get('sf_opportunity_name') or '—' }}</div></div>
    <div class="col-md-12">
      <div class="form-label">Salesforce Opportunity URL</div>
      <div class="form-control-plaintext">
        {% set u = data.get('sf_opportunity_url') %}
        {% if u and (u.startswith('http://') or u.startswith('https://')) %}
          <a href="{{u}}" target="_blank" rel="noopener">{{u}}</a>
        {% else %}—{% endif %}
      </div>
    </div>
    <div class="col-md-4">
      <div class="form-label">Existing VDI in environment?</div>
      <div class="form-control-plaintext">{{ yesno(data.get('existing_vdi')) }}</div>
    </div>
    {% if yesno(data.get('existing_vdi')) == 'Yes' %}
      <div class="col-12"><div class="form-label">If yes, top pain points</div><div class="form-control-plaintext">{{ data.get('existing_vdi_pain') or '—' }}</div></div>
    {% endif %}
    <div class="col-12">
      <div class="form-label">Voice of the Customer (VoC)</div>
      <div class="form-control-plaintext">{{ data.get('voc') or '—' }}</div>
    </div>
  </div>
</fieldset>

<!-- 1) Users & Scope -->
<fieldset class="border p-3 mb-4 rounded-2">
  <legend class="float-none w-auto px-2">Users & Scope</legend>
  <div class="row g-3">
    <div class="col-md-4"><div class="form-label">Total users</div><div class="form-control-plaintext">{{ data.get('total_users') or '—' }}</div></div>
    <div class="col-md-4"><div class="form-label">Concurrent users (peak)</div><div class="form-control-plaintext">{{ data.get('concurrent_users') or '—' }}</div></div>
    <div class="col-md-4"><div class="form-label"># of datacenters/regions</div><div class="form-control-plaintext">{{ data.get('num_datacenters') or '—' }}</div></div>
    <div class="col-12"><div class="form-label">Datacenters/regions (where)</div><div class="form-control-plaintext">{{ data.get('datacenters_detail') or '—' }}</div></div>
    <div class="col-md-4"><div class="form-label">Deployment type</div><div class="form-control-plaintext">{{ data.get('deployment_type') or '—' }}</div></div>

    <div class="col-12">
      <div class="form-label">User locations (regional mix)</div>
      <div class="row">
        {% for key,label in [('US','Continental US'),('US_HI','US – HI'),('US_AK','US – AK'),('CAN','Canada'),('LATAM','LATAM'),('EMEA','EMEA'),('APAC','APAC'),('INDIA','India'),('ANZ','ANZ'),('OTHER','Other')] %}
          <div class="col-md-3 mb-2">
            <div class="small">{{ label }}</div>
            <div class="form-control-plaintext">
              {% set ck = data.get('region_ck_' ~ key) %}
              {% set pct = data.get('region_pct_' ~ key) %}
              {{ 'Yes' if ck else 'No' }}{% if pct %} — {{ pct }}%{% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="col-md-4"><div class="form-label"># of distinct personas/use cases</div><div class="form-control-plaintext">{{ data.get('num_personas') or '—' }}</div></div>
    <div class="col-12"><div class="form-label">Main use case</div><div class="form-control-plaintext">{{ data.get('main_use_cases') or '—' }}</div></div>
    {% for i in range(2, 21) %}
      {% set k = 'secondary_use_case_' ~ i %}
      {% if data.get(k) %}
      <div class="col-12"><div class="form-label">Secondary use case {{ i }}</div><div class="form-control-plaintext">{{ data.get(k) }}</div></div>
      {% endif %}
    {% endfor %}
  </div>
</fieldset>

<!-- 2) Graphics / GPU -->
<fieldset class="border p-3 mb-4 rounded-2">
  <legend class="float-none w-auto px-2">Graphics / GPU</legend>
  <div class="row g-3">
    <div class="col-md-4"><div class="form-label">GPU Required?</div><div class="form-control-plaintext">{{ yesno(data.get('gpu_required')) }}</div></div>
    {% if yesno(data.get('gpu_required')) == 'Yes' %}
      <div class="col-md-4"><div class="form-label">GPU users (estimate)</div><div class="form-control-plaintext">{{ data.get('gpu_users') or '—' }}</div></div>
      <div class="col-md-4"><div class="form-label">Target GPU profile / VRAM per user (GB)</div><div class="form-control-plaintext">{{ data.get('gpu_vram_per_user') or '—' }}</div></div>
      <div class="col-12"><div class="form-label">GPU use case</div><div class="form-control-plaintext">{{ data.get('gpu_use_case') or '—' }}</div></div>
    {% endif %}
  </div>
</fieldset>

<!-- 3) Image & Applications -->
<fieldset class="border p-3 mb-4 rounded-2">
  <legend class="float-none w-auto px-2">Image & Applications</legend>
  <div class="row g-3">
    <div class="col-md-4"><div class="form-label"># of base images</div><div class="form-control-plaintext">{{ data.get('num_images') or '—' }}</div></div>
    <div class="col-md-4"><div class="form-label">Gold image provided by customer?</div><div class="form-control-plaintext">{{ data.get('gold_image_source') or '—' }}</div></div>

    <div class="col-md-4"><div class="form-label">Profile management</div>
      <div class="form-control-plaintext">
        {% set pm = data.get('profile_mgmt_list') or data.get('profile_mgmt') %}
        {% if pm %}{{ (pm if pm is string else ', '.join(pm)) }}{% else %}—{% endif %}
      </div>
    </div>

    <div class="col-md-4"><div class="form-label">Virtual apps?</div>
      <div class="form-control-plaintext">
        {% set va = data.get('virtual_apps_list') or data.get('virtual_apps') %}
        {% if va %}{{ (va if va is string else ', '.join(va)) }}{% else %}—{% endif %}
      </div>
    </div>

    {% set va_list = data.get('virtual_apps_list') or [] %}
    {% if 'App Volumes' in va_list or data.get('required_apps') %}
      <div class="col-12"><div class="form-label">Required applications</div><div class="form-control-plaintext">{{ data.get('required_apps') or '—' }}</div></div>
    {% endif %}

    <div class="col-md-4"><div class="form-label">WWT responsible for app packaging?</div><div class="form-control-plaintext">{{ yesno(data.get('wwt_app_packaging')) }}</div></div>
  </div>
</fieldset>

<!-- 4) Access & Identity -->
<fieldset class="border p-3 mb-4 rounded-2">
  <legend class="float-none w-auto px-2">Access & Identity</legend>
  <div class="row g-3">
    <div class="col-md-4"><div class="form-label">Remote access required?</div><div class="form-control-plaintext">{{ yesno(data.get('remote_access')) }}</div></div>
    <div class="col-md-4"><div class="form-label">MFA required?</div><div class="form-control-plaintext">{{ yesno(data.get('mfa_required')) }}</div></div>
    {% if yesno(data.get('mfa_required')) == 'Yes' %}
      <div class="col-md-4"><div class="form-label">Existing MFA solution</div><div class="form-control-plaintext">{{ data.get('mfa_solution') or '—' }}</div></div>
    {% endif %}
    <div class="col-md-4"><div class="form-label">Smart card authentication?</div><div class="form-control-plaintext">{{ yesno(data.get('smartcard')) }}</div></div>
    <div class="col-md-8"><div class="form-label">Workspace ONE Access or 3rd-party IdP</div><div class="form-control-plaintext">{{ data.get('idp_provider') or '—' }}</div></div>
  </div>
</fieldset>

<!-- 5) Endpoints -->
<fieldset class="border p-3 mb-4 rounded-2">
  <legend class="float-none w-auto px-2">Endpoints</legend>
  <div class="row g-3">
    <div class="col-md-4"><div class="form-label">Provision/configure endpoints?</div><div class="form-control-plaintext">{{ yesno(data.get('endpoint_provisioning')) }}</div></div>
    <div class="col-md-8"><div class="form-label">Endpoint types</div><div class="form-control-plaintext">{{ data.get('endpoint_types') or '—' }}</div></div>
    <div class="col-md-4"><div class="form-label">Thin client management required?</div><div class="form-control-plaintext">{{ data.get('thin_client_mgmt') or '—' }}</div></div>
  </div>
</fieldset>

<!-- 6) Directory & Core Services -->
<fieldset class="border p-3 mb-4 rounded-2">
  <legend class="float-none w-auto px-2">Directory & Core Services</legend>
  <div class="row g-3">
    <div class="col-md-4"><div class="form-label">Existing AD forest/domains?</div><div class="form-control-plaintext">{{ data.get('ad_exists') or '—' }}</div></div>
    <div class="col-md-4"><div class="form-label"># of domains / trusts</div><div class="form-control-plaintext">{{ data.get('num_domains') or '—' }}</div></div>
    <div class="col-md-6"><div class="form-label">Domain name for virtual desktops</div><div class="form-control-plaintext">{{ data.get('vd_domain_name') or '—' }}</div></div>
    <div class="col-md-6"><div class="form-label">Separate domain for core servers?</div><div class="form-control-plaintext">{{ data.get('core_domain_name') or '—' }}</div></div>
  </div>
</fieldset>

<!-- 7) Platform & Infra -->
<fieldset class="border p-3 mb-4 rounded-2">
  <legend class="float-none w-auto px-2">Platform & Infra</legend>
  <div class="row g-3">
    <div class="col-md-4"><div class="form-label">Hypervisor/platform</div><div class="form-control-plaintext">{{ data.get('platform') or '—' }}</div></div>
    <div class="col-md-4"><div class="form-label">General compute cluster available for core components?</div><div class="form-control-plaintext">{{ yesno(data.get('general_compute_cluster')) }}</div></div>

    <div class="col-md-3"><div class="form-label">Host CPU cores</div><div class="form-control-plaintext">{{ data.get('host_cpu_cores') or '—' }}</div></div>
    <div class="col-md-3"><div class="form-label">Host RAM (GB)</div><div class="form-control-plaintext">{{ data.get('host_ram_gb') or '—' }}</div></div>
    <div class="col-md-3"><div class="form-label"># of hosts (cluster)</div><div class="form-control-plaintext">{{ data.get('hosts_count') or '—' }}</div></div>
    <div class="col-md-3"><div class="form-label">VM vCPU</div><div class="form-control-plaintext">{{ data.get('vm_vcpu') or '—' }}</div></div>
    <div class="col-md-3"><div class="form-label">VM RAM (GB)</div><div class="form-control-plaintext">{{ data.get('vm_ram_gb') or '—' }}</div></div>
    <div class="col-md-3"><div class="form-label">vCPU : pCPU ratio</div><div class="form-control-plaintext">{{ data.get('vcpu_to_pcpu') or '—' }}</div></div>

    <div class="col-md-3"><div class="form-label">Storage type</div><div class="form-control-plaintext">{{ data.get('storage_type') or '—' }}</div></div>

    {% if (data.get('storage_type') or '').strip() == 'vSAN' %}
      <div class="col-md-3"><div class="form-label">Base image size (GB)</div><div class="form-control-plaintext">{{ data.get('base_image_gb') or '—' }}</div></div>
      <div class="col-md-3"><div class="form-label">vSAN policy factor</div><div class="form-control-plaintext">{{ data.get('vsan_policy_factor') or '—' }}</div></div>
      <div class="col-12">
        <details>
          <summary>Advanced vSAN & density tunables</summary>
          <div class="row g-3 mt-2">
            <div class="col-md-3"><div class="form-label">IC delta per user (GB)</div><div class="form-control-plaintext">{{ data.get('delta_gb') or '—' }}</div></div>
            <div class="col-md-3"><div class="form-label">Per-VM overhead (GB)</div><div class="form-control-plaintext">{{ data.get('per_vm_overhead_gb') or '—' }}</div></div>
            <div class="col-md-3"><div class="form-label">Growth/cushion factor</div><div class="form-control-plaintext">{{ data.get('growth_factor') or '—' }}</div></div>
            <div class="col-md-3"><div class="form-label">Mem headroom (%)</div><div class="form-control-plaintext">{{ data.get('mem_headroom_pct') or '—' }}</div></div>
            <div class="col-md-3"><div class="form-label">ESXi overhead (GB)</div><div class="form-control-plaintext">{{ data.get('esxi_overhead_gb') or '—' }}</div></div>
            <div class="col-md-3"><div class="form-label">GPU sessions cap (per host)</div><div class="form-control-plaintext">{{ data.get('gpu_sessions_cap') or '—' }}</div></div>
          </div>
        </details>
      </div>
    {% else %}
      {% if data.get('storage_type') %}
        <div class="col-md-4"><div class="form-label">Storage vendor/model</div><div class="form-control-plaintext">{{ data.get('storage_vendor_model') or '—' }}</div></div>
        <div class="col-md-4"><div class="form-label">Protocol</div><div class="form-control-plaintext">{{ data.get('storage_protocol') or '—' }}</div></div>
        <div class="col-md-4"><div class="form-label">Usable capacity (GB)</div><div class="form-control-plaintext">{{ data.get('storage_usable_gb') or '—' }}</div></div>
      {% endif %}
    {% endif %}

    <div class="col-md-4"><div class="form-label">Load balancer</div><div class="form-control-plaintext">{{ data.get('load_balancer') or '—' }}</div></div>
  </div>
</fieldset>

<!-- 8) Operations & Enablement -->
<fieldset class="border p-3 mb-4 rounded-2">
  <legend class="float-none w-auto px-2">Operations & Enablement</legend>
  <div class="row g-3">
    <div class="col-md-6"><div class="form-label">Operations staffing</div><div class="form-control-plaintext">{{ data.get('ogs_staffing') or '—' }}</div></div>
    <div class="col-md-6"><div class="form-label">Monitoring</div><div class="form-control-plaintext">{{ data.get('monitoring_stack') or '—' }}</div></div>
    <div class="col-md-12"><div class="form-label">Training required</div>
      <div class="form-control-plaintext">
        {% set tr = data.get('training_required_list') or data.get('training_required') %}
        {% if tr %}{{ (tr if tr is string else ', '.join(tr)) }}{% else %}—{% endif %}
      </div>
    </div>
    <div class="col-md-6">
      <div class="form-label">Typical onboarding time (per user)</div>
      <div class="form-control-plaintext">
        {% set v = data.get('onboarding_time_value') %}
        {% set u = data.get('onboarding_time_unit') %}
        {% if v or u %}{{ v or '—' }} {{ u or '' }}{% else %}—{% endif %}
      </div>
    </div>
    <div class="col-md-12"><div class="form-label">Knowledge Transfer (KT) expectations</div><div class="form-control-plaintext">{{ data.get('kt_expectations') or '—' }}</div></div>
    <div class="col-md-4"><div class="form-label">Runbook required?</div><div class="form-control-plaintext">{{ yesno(data.get('runbook_required')) }}</div></div>
    <div class="col-md-4"><div class="form-label">Adoption Services needed?</div><div class="form-control-plaintext">{{ yesno(data.get('adoption_services')) }}</div></div>
    <div class="col-md-4"><div class="form-label">HA/DR in-scope?</div><div class="form-control-plaintext">{{ yesno(data.get('ha_dr')) }}</div></div>
  </div>
</fieldset>

<!-- 9) Logistics & Delivery Model -->
<fieldset class="border p-3 mb-4 rounded-2">
  <legend class="float-none w-auto px-2">Logistics & Delivery Model</legend>
  <div class="row g-3">
    <div class="col-md-8"><div class="form-label">Delivery model</div><div class="form-control-plaintext">{{ data.get('delivery_model') or '—' }}</div></div>
    <div class="col-md-4"><div class="form-label">Target start date</div><div class="form-control-plaintext">{{ data.get('start_date') or '—' }}</div></div>
    <div class="col-md-4"><div class="form-label">Timeline / deadlines</div><div class="form-control-plaintext">{{ data.get('timeline') or '—' }}</div></div>

    <div class="col-md-8">
      <div class="form-label">Docs requested</div>
      <div class="form-control-plaintext">
        {% set dr = data.get('docs_requested_list') or data.get('docs_requested') %}
        {% if dr %}{{ (dr if dr is string else ', '.join(dr)) }}{% else %}—{% endif %}
      </div>
    </div>

    <div class="col-12"><div class="form-label">Stakeholders / 3rd parties</div><div class="form-control-plaintext">{{ data.get('stakeholders') or '—' }}</div></div>
  </div>
</fieldset>

{% endblock %}
