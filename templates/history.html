{% extends "base.html" %}
{% block title %}History{% endblock %}
{% block head %}
<script>
(function(){
  var table = document.getElementById('histTable') || document.querySelector('table');
  if (!table) return;
  var thead = table.tHead && table.tHead.rows[0];
  var tbody = table.tBodies && table.tBodies[0];
  if (!thead || !tbody) return;

  // locate status column index
  var statusIdx = -1;
  for (var i=0;i<thead.cells.length;i++){
    var th = thead.cells[i];
    var key = (th.getAttribute('data-key')||'').toLowerCase();
    var txt = (th.textContent||'').trim().toLowerCase();
    if (key==='status' || txt==='status'){ statusIdx=i; break; }
  }
  if (statusIdx<0) return;

  // populate dropdown from table values (client-side backup)
  var sel = document.getElementById('filterStatus');
  if (sel){
    var seen = new Set();
    Array.prototype.slice.call(tbody.rows).forEach(function(r){
      var c = r.cells[statusIdx];
      if (!c) return;
      var v = (c.textContent||'').trim();
      if (v) seen.add(v);
    });
    var existing = new Set(Array.prototype.slice.call(sel.options).map(function(o){return o.value;}));
    Array.prototype.slice.call(Array.from(seen).sort()).forEach(function(v){
      if (!existing.has(v)){
        var opt = document.createElement('option'); opt.value=v; opt.textContent=v; sel.appendChild(opt);
      }
    });
    sel.addEventListener('change', function(){
      var want = (sel.value||'').toLowerCase();
      Array.prototype.slice.call(tbody.rows).forEach(function(r){
        var cell = r.cells[statusIdx];
        var have = (cell && cell.textContent || '').trim().toLowerCase();
        r.style.display = (!want || have === want) ? '' : 'none';
      });
    });
  }

  // standalone sorter for Status header (without touching your existing code)
  var thStatus = thead.cells[statusIdx];
  if (thStatus){
    thStatus.style.cursor='pointer';
    var asc = true;
    thStatus.addEventListener('click', function(){
      var rows = Array.prototype.slice.call(tbody.rows);
      rows.sort(function(a,b){
        var A = (a.cells[statusIdx]?.textContent||'').trim().toLowerCase();
        var B = (b.cells[statusIdx]?.textContent||'').trim().toLowerCase();
        if (A<B) return asc ? -1 : 1;
        if (A>B) return asc ? 1 : -1;
        return 0;
      });
      asc = !asc;
      rows.forEach(function(r){ tbody.appendChild(r); });
    });
  }
})();
</script>
{% endblock %}

{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h3 mb-0">Submissions History</h1>
  <span class="text-muted">v1.2 — sortable & filterable</span>
</div>

<div class="row g-2 mb-3">
  <div class="col-md-4">
    <label class="form-label">Search (Company or Project)</label>
    <input id="searchAll" type="text" class="form-control" placeholder="Type to search…">
  </div>
  <div class="col-md-4">
    <label class="form-label">Filter by Company</label>
    <input id="searchCompany" type="text" class="form-control" placeholder="Company name…">
  </div>
  <div class="col-md-4">
    <label class="form-label">Filter by Project</label>
    <input id="searchProject" type="text" class="form-control" placeholder="Project name…">
  </div>

  <div class="col-md-4">
    <label class="form-label">Filter by Status</label>
    <select id="filterStatus" class="form-select">
      <option value="">All statuses</option>
      {# Server-side population to avoid empty dropdown #}
      {% if rows %}
        {% set _st = rows | map(attribute='status') | list %}
        {% for s in (_st | unique | sort) %}
          {% if s %}<option value="{{ s }}">{{ s }}</option>{% endif %}
        {% endfor %}
      {% endif %}
    </select>
  </div>
</div>

<div class="table-responsive">
  <table id="histTable" class="table table-sm table-hover align-middle" style="font-size: 0.9rem;">
  <thead class="table-light">
    <tr>
      <th role="button" data-key="company">Company</th>
      <th role="button" data-key="project">Project</th>
      <th role="button" data-key="sales_pnl">P&amp;L</th>
      <th role="button" data-key="da_probability">DA Probability (%)</th>
      <th role="button" data-key="estimated_close_date">Close date</th>
      <th data-key="status" role="button">Status</th>
      <th role="button" data-key="submitted">Submitted</th>
    </tr>
  </thead>
  <tbody>
    {% for r in rows %}
    {% set href = url_for('presales_view', submit_id=r.id) %}
    <tr>
      <td data-key="company"><a class="text-truncate d-inline-block" style="max-width: 220px;" title="{{ r.company_name }}" href="{{ href }}">{{ r.company_name or '—' }}</a></td>
      <td data-key="project"><a class="text-truncate d-inline-block" style="max-width: 220px;" title="{{ r.project_name }}" href="{{ href }}">{{ r.project_name or '—' }}</a></td>
      <td data-key="sales_pnl"><span class="text-truncate d-inline-block" style="max-width: 120px;" title="{{ r.sales_pnl }}">{{ r.sales_pnl or '' }}</span></td>
      <td data-key="da_probability">{{ r.da_probability or '' }}</td>
      <td data-key="estimated_close_date">{{ r.estimated_close_date or '' }}</td>
      <td data-key="status">{{ r.status or '' }}</td>
      <td data-key="submitted"><a href="{{ href }}">{{ (r.submitted_at or '')[:10] }}</a></td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<script>
(function(){
  var table = document.getElementById('histTable');
  if (!table) return;
  var tbody = table.tBodies[0];
  function keyText(row, key){
    var cell = row.querySelector('[data-key="'+key+'"]');
    return (cell && cell.textContent || '').trim();
  }
  var state = {key:null, asc:true};
  table.querySelectorAll('thead th[data-key]').forEach(function(th){
    th.style.cursor = 'pointer';
    th.addEventListener('click', function(){
      var key = th.getAttribute('data-key');
      var asc = (state.key===key) ? !state.asc : true;
      var rows = Array.prototype.slice.call(tbody.rows);
      rows.sort(function(a,b){
        var A = keyText(a,key), B = keyText(b,key);
        var nA = parseFloat(A), nB = parseFloat(B);
        if (!isNaN(nA) && !isNaN(nB)) return asc ? (nA-nB) : (nB-nA);
        var dateRe = /^\d{4}-\d{2}-\d{2}$/;
        if (dateRe.test(A) && dateRe.test(B)) return asc ? A.localeCompare(B) : B.localeCompare(A);
        return asc ? A.localeCompare(B) : B.localeCompare(A);
      });
      rows.forEach(function(r){ tbody.appendChild(r); });
      state = {key:key, asc:asc};
    });
  });
})();
</script>

</div>

<script>
(function(){
  const table = document.getElementById('histTable');
  const tbody = table.querySelector('tbody');
  const headers = table.querySelectorAll('thead th[role="button"]');
  const inputAll = document.getElementById('searchAll');
  const inputCompany = document.getElementById('searchCompany');
  const inputProject = document.getElementById('searchProject');

  function normalize(s){ return (s || '').toLowerCase(); }

  function rowMatchesFilters(tr){
    const company = normalize(tr.querySelector('td[data-key="company"]').innerText);
    const project = normalize(tr.querySelector('td[data-key="project"]').innerText);
    const submitted = normalize(tr.querySelector('td[data-key="submitted"]').innerText);

    const qAll = normalize(inputAll.value);
    const qCo  = normalize(inputCompany.value);
    const qPr  = normalize(inputProject.value);

    const allHit = !qAll || company.includes(qAll) || project.includes(qAll) || submitted.includes(qAll);
    const coHit  = !qCo || company.includes(qCo);
    const prHit  = !qPr || project.includes(qPr);

    return allHit && coHit && prHit;
  }

  function applyFilters(){
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.forEach(tr => {
      tr.style.display = rowMatchesFilters(tr) ? '' : 'none';
    });
  }

  function sortBy(colKey, ascending){
    const rows = Array.from(tbody.querySelectorAll('tr')).filter(tr => tr.style.display !== 'none');
    rows.sort((a,b) => {
      const av = a.querySelector(`td[data-key="${colKey}"]`).innerText.trim().toLowerCase();
      const bv = b.querySelector(`td[data-key="${colKey}"]`).innerText.trim().toLowerCase();
      if (av < bv) return ascending ? -1 : 1;
      if (av > bv) return ascending ? 1 : -1;
      return 0;
    });
    rows.forEach(tr => tbody.appendChild(tr));
  }

  function clearAriaSortExcept(th){
    headers.forEach(h => { if (h !== th) h.setAttribute('aria-sort','none'); });
  }

  headers.forEach(th => {
    th.addEventListener('click', () => {
      const current = th.getAttribute('aria-sort') || 'none';
      let nextAsc = true;
      if (current === 'none' || current === 'ascending') {
        nextAsc = current !== 'ascending'; // flip to descending if already ascending
      } else {
        nextAsc = true; // if was descending, go to ascending
      }
      th.setAttribute('aria-sort', nextAsc ? 'ascending' : 'descending');
      clearAriaSortExcept(th);
      sortBy(th.dataset.col || th.dataset.key, nextAsc); // prefer data-key
    });
  });

  [inputAll, inputCompany, inputProject].forEach(inp => {
    inp.addEventListener('input', applyFilters);
  });

  // Initial filter & default sort on Submitted (descending)
  applyFilters();
  sortBy('submitted', false);
})();
</script>


<script>
(function(){
  var table = document.getElementById('histTable') || document.querySelector('table');
  if (!table) return;
  var thead = table.tHead && table.tHead.rows[0];
  var tbody = table.tBodies && table.tBodies[0];
  if (!thead || !tbody) return;

  // locate status column index
  var statusIdx = -1;
  for (var i=0;i<thead.cells.length;i++){
    var th = thead.cells[i];
    var key = (th.getAttribute('data-key')||'').toLowerCase();
    var txt = (th.textContent||'').trim().toLowerCase();
    if (key==='status' || txt==='status'){ statusIdx=i; break; }
  }
  if (statusIdx<0) return;

  // populate dropdown from table values (client-side backup)
  var sel = document.getElementById('filterStatus');
  if (sel){
    var seen = new Set();
    Array.prototype.slice.call(tbody.rows).forEach(function(r){
      var c = r.cells[statusIdx];
      if (!c) return;
      var v = (c.textContent||'').trim();
      if (v) seen.add(v);
    });
    var existing = new Set(Array.prototype.slice.call(sel.options).map(function(o){return o.value;}));
    Array.prototype.slice.call(Array.from(seen).sort()).forEach(function(v){
      if (!existing.has(v)){
        var opt = document.createElement('option'); opt.value=v; opt.textContent=v; sel.appendChild(opt);
      }
    });
    sel.addEventListener('change', function(){
      var want = (sel.value||'').toLowerCase();
      Array.prototype.slice.call(tbody.rows).forEach(function(r){
        var cell = r.cells[statusIdx];
        var have = (cell && cell.textContent || '').trim().toLowerCase();
        r.style.display = (!want || have === want) ? '' : 'none';
      });
    });
  }

  // standalone sorter for Status header (without touching your existing code)
  var thStatus = thead.cells[statusIdx];
  if (thStatus){
    thStatus.style.cursor='pointer';
    var asc = true;
    thStatus.addEventListener('click', function(){
      var rows = Array.prototype.slice.call(tbody.rows);
      rows.sort(function(a,b){
        var A = (a.cells[statusIdx]?.textContent||'').trim().toLowerCase();
        var B = (b.cells[statusIdx]?.textContent||'').trim().toLowerCase();
        if (A<B) return asc ? -1 : 1;
        if (A>B) return asc ? 1 : -1;
        return 0;
      });
      asc = !asc;
      rows.forEach(function(r){ tbody.appendChild(r); });
    });
  }
})();
</script>

{% endblock %}
